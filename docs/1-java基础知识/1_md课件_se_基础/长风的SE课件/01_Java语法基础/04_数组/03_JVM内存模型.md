# ③JVM内存模型

[TOC]

---



## 1. JVM运行时数据区域

> 程序在运行期间，需要处理很多数据，JVM中有专门的区域来存放这些数据

- 这片区域称之为**JVM的运行时数据区域**
- 该区域中的变量不是杂乱无章的摆放的，而是被JVM分区管理的
  - 这些区域各有各的用途，创建时间，销毁时间等皆有不同
  - 与之相对的
  - 不同区域中变量的生命周期、特点和使用方式也会随之产生差异

- 理解JVM运行时内存是学习Java的基本，这个东西并不底层，需要每位同学都掌握
- 理解JVM运行时内存，能够加深我们对Java中的很多现象的理解





## 2. JVM内存模型图

> 为了描述JVM内存空间，Java的开发者在《Java虚拟机规范》中指出：JVM （运行时数据区）内存共分为：
>
> - JVM栈
> - 堆
> - 方法区
> - 程序计数器
> - 本地方法栈

- 示意图如下



<img src="https://raw.githubusercontent.com/ytwotap/imgCloud/main/typora/pugin-picture20210618112823.png" alt="image-20201223172601885" style="zoom: 50%;" />



### 2.1 JVM内存模型详解

- JVM栈（以后简称栈，stack）：描述的是Java的（普通）方法执行时的所占内存的内存模型
  - 程序运行时调用方法的代价是：要占用栈的内存空间
    - 方法栈帧中主要存储方法中的局部变量（空间和数据一起存储）
  - 方法的执行流程（内存中）
    - 每当Java程序执行一个方法，都会在栈上分配一块只属于该方法的内存区域，称之为“栈帧”
    - 也就是说，每当Java程序执行一个方法，都会将一个存储该方法信息的**栈帧**压入栈中，称之为“方法进栈”
    - 方法进栈的同时局部变量进行声明和初始化，局部变量生效
    - 当方法执行完毕后，该方法的栈帧随之销毁，称之为“方法的出栈”
    - 栈帧被销毁的同时，局部变量也被销毁，局部变量失效
    - 栈中只有处于栈顶的栈帧才会生效，称之为当前栈帧，当前方法
- 堆（heap）：堆是JVM内存中最大的一块，new出来的东西（称之为对象或者实例）都在堆上
  - 使用new关键字，意思是在堆上开辟一片空间给相应的对象
  - 这片空间（对象）是有内存地址的，这个内存地址是留给外界访问用的
    - 引用数据用比较运算符比较的地址就是这个地址，即比较对象的地址
- 方法区（method area）：面向对象详细讲
- 本地方法栈：和JVM栈类似，区别是本地方法栈是给[本地（native）方法](https://www.jianshu.com/p/22517a150fe5)使用的，而不是普通方法
- 程序计数器：JVM执行代码是一行一行执行字节码，程序计数器用来记录当前执行的行数





## 3. 什么是引用数据类型

> 引用数据类型是Java的两个数据类型之一，通过数组初始化的内存分配过程来一窥引用数据类型的特点

- 引用数据类型的创建分为两部分：
  - 首先是在栈上分配一片空间给引用数据类型的引用，简称“引用”
  - 在堆上开辟一片空间，用于存放引用数据类型的具体信息，称之为“对象”或者“实例”
    - **对象是引用数据类型的实质**

- 栈上的引用指向了堆上对象的内存地址
- 我们只能通过引用（变量名）去间接的访问，堆上的对象。无法直接访问堆上对象





### 3.1 基本数据类型和引用数据类型的区别

- 存储位置（本质区别）：
  - 基本数据类型不存在”引用“的概念，数据都是直接存储在栈上的栈帧里；
  - 引用数据类型在栈帧中存储引用，引用存储的只是该引用类型在堆上对象的内存地址
    - 堆上对象存储才是引用数据类型的具体信息

- 打印变量名内容：
  - 基本数据类型，打印变量名就是该变量具体的数值
  - 引用数据类型，打印变量名显示该引用变量堆上的内存地址



## 4. 堆上对象和栈中变量的区别

> 从以下三个角度来分析这个问题
>
> 1，从存储的类型来看
>
> 2，从默认值来看
>
> 3，生命周期来看

1. 从存储的类型来看：
   - 堆上存储的是new出来的东西，是引用数据类型的对象
   - 栈上存储的是局部变量（基本数据类型，引用类型的引用）

2. 从默认值来看：
   - 堆上的变量具有默认值
     - 整形（byte、short、int、long）默认值为0
     - 浮点类型（float、double）默认值为0.0
     - 字符类型（char）默认值是'\u0000' 空字符
     - 布尔类型（boolean）默认值是false
     - 引用数据类型默认值是null 
       - null既不是对象也不是任何一种数据类型，它仅是一个特殊的值
       - 任何引用都可以指向null，指向null并不意味着没有初始化
       - 引用指向null，表示该引用没有指向对象，该引用数据类型无法正常使用
       - 基本数据类型不能等于null
   - 栈上变量没有默认值，声明必须显式的初始化，否则无法使用
   
3. 生命周期来看：

   - 堆上的对象使用完毕后，就会变成“垃圾”，会等待垃圾回收器进行内存回收

     - 堆上的对象变成垃圾后，并不是立刻就会被回收，而是等待垃圾回收器进行回收
     - 整个垃圾回收的过程都是由Java的垃圾回收机制自动完成的，极大的节省了Java程序员的精力
     - 垃圾回收是Java和C++之间的一道围墙，墙外的人想进来，墙内的人却想出去

   - 栈上的局部变量的生命周期和栈帧保持一致

     - 方法栈帧进栈后，局部变量就被声明分配空间了
     - 方法出栈后，局部变量就被销毁了

     



> 一个经典的初学者问题

既然引用数据类型具有默认初始化，那为什么声明一个数组后不能立刻使用呢？

